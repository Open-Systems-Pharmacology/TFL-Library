---
title: "Time Profile Plot Vignette"
author: "OSPSuiteR 2019"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{time-profile-vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction
The following vignette aims at illustrating the workflow for performing Time Profile plots using the `tlf`-Library.

## Libraries

The main purpose of the `tlf`-library is to help in plotting standardized `ggplot` objects out of the `OSPSuiteR`. As such, `ggplot2` package needs to be installed.

```{r setup}
# The update of the tlf library with document needs to be called in the vignette
# Otherwise, the library is not up to date to be knitted
devtools::document()
library(tlf)
library(ggplot2)
```

The usual workflow suggested for performing any kind of plot with the `tlf`-library is specified and illustrated below. 
Please note that steps 2, 3 and 4 are not mandatory and will use default values if they are not defined. Besides, steps 3 and 4 can be independant.

1. Get the data to plot
2. Pre-process the data using `TimeProfileHelper` and `Groupings` classes and their built-in functions
3. Set the `dataMapping` which will define what you would like to plot
4. Set the `plotConfiguration` which will define how you would like to plot the data previously mapped
5. Plot the data using the dedicated function

## `tlf` workflow
```{r, out.width="100%", include=TRUE, fig.align="center", echo=FALSE}
knitr::include_graphics("AbdullahSlide.png")
```


# 1. Data

In the sequel, the data used for the time profile plot is a `data.frame` variable named `timeProfileDataFrame`.
A `metaData` variable can be used in association to the data. Its main purpose is to define additional information on the data such as the `dimension` and `units` of each of its variables. The lower limit of quantitiation of time profile data can be stored in such metaData.

## Dataset
```{r, results='asis'}
# Data frame printed in a nice markdown table:
pander::pandoc.table(timeProfileDataFrame[,c("IndividualID", "Time", "Gender", "Age", "Simulated")], justify='right', round=2)
```

## MetaData
```{r, results='asis'}
timeProfileMetaData <- list(Time = list(unit = "min", dimension = "time"), 
                            Simulated = list(unit = "ug/mL", dimension = "concentration"))
```


# 2. Pre-processing of the data

## Groupings
The `R6` class `Groupings` can help you process some of the data and define grouping variables which are often used by `ggplot` to split the data and create subsequent legend and captions.
This class defines `GroupMapping` for any aesthetic parameter of `ggplot`.
Two types of input can be submitted to `GroupMapping` a `character` type indicating the name of the variables to be used for grouping; and a `data.frame` type directly linking the grouping variables to the grouping variable at the last column of the data.frame.
The optional input `label` indicates the name of the grouping variable resulting from the mapping.

Below are use cases of the `GroupMapping`:

```{r, results='asis'}
# Grouping by variable names:
grouping1 <- GroupMapping$new(c("Compound", "Dose"))

# Grouping by variable names and overwriting the default label:
grouping2 <- GroupMapping$new(c("Compound", "Dose"), label = "Compound & Dose")

# Grouping using a data.frame:
mappingDataFrame <- data.frame(IndividualID = c(1,2,3,4) , 
                                    PatientName = c("Paul", "John", "George", "Ringo"))

grouping3 <- GroupMapping$new(mappingDataFrame)

# Aplly the mapping to get the grouping captions:
groupingsDataFrame <- data.frame(
  timeProfileDataFrame$IndividualID,
  timeProfileDataFrame$Dose,
  timeProfileDataFrame$Compound,
  grouping1$getCaptions(timeProfileDataFrame),
  grouping2$getCaptions(timeProfileDataFrame),
  grouping3$getCaptions(timeProfileDataFrame))

names(groupingsDataFrame) <- c("IndividualID", "Dose", "Compound",
                               grouping1$label, grouping2$label, grouping3$label)

# Show results for all groupings:
pander::pandoc.table(groupingsDataFrame)
```

Then, this association can be used in `dataMapping` of type `XYGDataMapping` through the class `Groupings` which will map any `GroupMapping` to an aesthetic parameter such as `color` or `linetype`. `Groupings` can use directly the input of `GroupMapping` to improve efficiency.

```{r, results='asis'}
# Map groups to aesthtic properties
groups <- Groupings$new(color = c("Compound", "Dose"),
                        shape = mappingDataFrame)

# Aplly the mapping to get the grouping captions:
dataMapping <- XYGDataMapping$new(x="Time", y="Simulated", groupings = groups)

# Show results for all groupings:
pander::pandoc.table(dataMapping$getMapData(data = timeProfileDataFrame,
                                            metaData = timeProfileMetaData))
```

## Helper

The `R6` class `TimeProfileHelper` can help you process some of the time profile data and obtain new aggregated data to plot. 
When initializing this helper, `valuesColumnNames` are the variables to be aggregated, `groupingColumnNames` are the variables that will group the data for the aggragtion , `aggregationFunctionsVector` is a vector of functions to be used during the aggregation and `aggregationFunctionNames` the name of the associated variables within the output `data.frame` of the helper.

The following example illustrates the outcome of the helper:
```{r, results='asis'}
hlp <- TimeProfileHelper$new(data = timeProfileDataFrame,
                             timeColumnName = "Time",
                             groupingColumnNames = c("Population"),
                             valuesColumnNames = "Simulated",
                             aggregationFunctionsVector = c(mean, min, max),
                             aggregationFunctionNames =  c("SimulatedMean", "SimulatedMin", "SimulatedMax"))


pander::pandoc.table(hlp$dfHelper, round=2)
```

# 3. dataMapping

The `R6` class `TimeProfileDataMapping` is dedicated to map `x`, `y` and `groupings` for time profile plots.
Its inner function `getMapData` creates an output `data.frame` mapping the `x`, `y` and `groupings` of any input `data`.

The basic example is to map only `x` and `y`:
```{r, results='asis'}
tpMapping <- TimeProfileDataMapping$new(x="Time", y="Simulated")
pander::pandoc.table(tpMapping$getMapData(data = timeProfileDataFrame,
                                          metaData = timeProfileMetaData))
```

A more complex example is to add `groupings` to `x` and `y`:
```{r, results='asis'}
# Re-use the variable groups previously defined
tpMapping <- TimeProfileDataMapping$new(x="Time", y="Simulated", 
                                        groupings = groups)

pander::pandoc.table(tpMapping$getMapData(data = timeProfileDataFrame,
                                          metaData = timeProfileMetaData))
```

Specific to time profiles, `TimeProfileDataMapping` allows the mapping of `yMin` and `yMax`.
These parameters are expected in case error bars are needed or in case a time range profile is needed.
If only `yMin` and `yMax` are input in the mapping `y` being undefined or `NULL`, the expected profile is a range.
If `y`, `yMin` and `yMax` are input in the mapping, the expected profile is an error bar.

```{r, results='asis'}
# Use the helper to aggregate min and max values

hlp <- TimeProfileHelper$new(data = timeProfileDataFrame,
                             timeColumnName = "Time",
                             groupingColumnNames = c("Population"),
                             valuesColumnNames = "Simulated",
                             aggregationFunctionsVector = c(mean, min, max),
                             aggregationFunctionNames =  c("SimulatedMean", "SimulatedMin", "SimulatedMax"))

# Define Mapping with yMin and yMax
tpMapping <- TimeProfileDataMapping$new(x="Time", y="SimulatedMean", 
                                        yMin = "SimulatedMin", yMax = "SimulatedMax")

pander::pandoc.table(tpMapping$getMapData(data = hlp$dfHelper,
                                          metaData = hlp$metaDataHelper))
```


# 4. plotConfiguration

## Theme

A `Theme` class can be used to standardize plot configurations. So far, 4 predefined themes are available: `defaultTheme`, `tlfTheme`, `bwTheme` and `bigTheme`. The function `useTheme` set a theme as the current theme of the environment. As for instance: `useTheme(tlfTheme)`.

## Plot Configuration for time profiles

The `R6` class `TimeProfilePlotConfiguration` is dedicated to set the configuration of time profile plots. It inherits from the `R6` class `PlotConfiguration` and as such it is split into 4 subclasses:

- `LabelConfiguration` from which any `PlotConfiguration` inherits and that defines the size and fonts of the labels (title, xlabel, ...)
- `XAxisConfiguration` that defines the limits, scale and ticks of the x-axis
- `YAxisConfiguration` that defines the limits, scale and ticks of the y-axis
- `LegendConfiguration` that defines the titles, captions and values for any aesthetic parameter (`color`, `linetype`,...)


The definition of the configuration can be performed as follows:
```{r}
config <- PlotConfiguration$new(title = "Title",
                      xlabel = "x-axis label", 
                      ylabel = "y-axis label", 
                      watermark = "background")

# Overall features of the configurtion
config

# Title and its configuration
config$title
config$title$font

# scale of x axis
config$xAxis$scale

```

Example for a time profile plot:
```{r}
tpConfig <- TimeProfilePlotConfiguration$new()

# Overall features of the configurtion
tpConfig
```

Since the plot configuration is not a necessary input for the plot functions, it can use default values if not overwritten. Called within plot functions its default values use data, metaData and dataMapping as input to get a smarter configuration.

Below is an example for a time profile configuration using data, metaData and dataMapping:

```{r}
# Define the time profile mapping
tpMapping <- TimeProfileDataMapping$new(x="Time", y="Simulated")

# Define the time profile configuration using
# data, metaData and dataMapping
tpConfig <- TimeProfilePlotConfiguration$new(data = timeProfileDataFrame,
                                             metaData = timeProfileMetaData,
                                             dataMapping = tpMapping)

# Overall features of the configurtion
tpConfig
```

# 5. Examples

The function that creates ggplot objects for time profiles is `plotTimeProfile` whose input arguments are `data`, `metaData`, `dataMapping` and `plotConfiguration`.

## 5.1. Basic example of time profile plot

```{r, fig.height=5, fig.width=7.5}
# Map x and y of the plot
tpMapping <- TimeProfileDataMapping$new(x="Time", y="Simulated")

# Define the ggplot object
plotObject <- plotTimeProfile(data=timeProfileDataFrame, 
                              metaData = timeProfileMetaData,
                              dataMapping = tpMapping)
# Show plot
plotObject

```

You can notice that the plot presents almost error bars, this is due to the fact that the plot has more than 1 value per time point.

## 5.2. Workflow example of time profile plot using `TimeProfilePlotConfiguration`

```{r, fig.height=5, fig.width=7.5}
# Set current theme
useTheme(tlfTheme)

# Map x and y of the plot
tpMapping <- TimeProfileDataMapping$new(x="Time", y="Simulated")

# Overwrite plot configuration 
tpConfig <- TimeProfilePlotConfiguration$new(title = "New Plot",
                                             ylabel = "Simulated Results",
                                             data = timeProfileDataFrame,
                                             metaData = timeProfileMetaData,
                                             dataMapping = tpMapping)

# Define the ggplot object with updated configuration
plotObject <- plotTimeProfile(data=timeProfileDataFrame, 
                              metaData = timeProfileMetaData,
                              dataMapping = tpMapping, 
                              plotConfiguration = tpConfig)
# Show plot
plotObject

```

## 5.3. Workflow example of time profile plot using `TimeProfileDataMapping` with `Groupings`

```{r, fig.height=5, fig.width=7.5}
# Map x, y and groups of the plot
groups <- Groupings$new(color = "IndividualID", 
                        linetype = "Population")

tpMapping <- TimeProfileDataMapping$new(x = "Time", 
                                        y = "Simulated", 
                                        groupings = groups)

# Define the ggplot object
plotObject <- plotTimeProfile(data=timeProfileDataFrame,
                           metaData = timeProfileMetaData,
                           dataMapping = tpMapping)

# Show plot
plotObject

```

## 5.4. Workflow example of time profile plot using `TimeProfileDataMapping` with `Groupings` as data.frame

```{r, fig.height=5, fig.width=7.5}
# data.frame associating grouping to Individual ID with their captions
groupingIndividualsDf <- data.frame(IndividualID = c(1,2,3,4) , 
                                    "Name of Beatle" = c("Paul", "John", "George", "Ringo"))
# Define the grouping variable
groups = Groupings$new(color = groupingIndividualsDf)

# Map x, y and groups
tpMapping <- TimeProfileDataMapping$new(x = "Time",
                                        y = "Simulated",
                                        groupings = groups)

# Define the ggplot object
plotObject <- plotTimeProfile(data=timeProfileDataFrame,
                           metaData = timeProfileMetaData,
                           dataMapping = tpMapping)

# Show plot
plotObject

```

## 5.5. Workflow example of time profile plot using `TimeProfileDataMapping` with `Helper`

### 5.5.1. Plot aggregated mean value
```{r, fig.height=5, fig.width=7.5}
# Define aggregated values through helper
hlp <- TimeProfileHelper$new(data = timeProfileDataFrame,
                             timeColumnName = "Time",
                             groupingColumnNames = c("Population"),
                             valuesColumnNames = "Simulated",
                             aggregationFunctionsVector = c(mean, min, max),
                             aggregationFunctionNames =  c("SimulatedMean", "SimulatedMin", "SimulatedMax"))

# Map x and y
tpMappingMean <- TimeProfileDataMapping$new(x = "Time", 
                                            y = "SimulatedMean")
# Overwrite the plot configuration
tpConfig <-  TimeProfilePlotConfiguration$new(ylabel = "Simulated Results",
                                              xlabel = "Time")

# Define the ggplot object
meanPlot <- plotTimeProfile(data=hlp$dfHelper,
                            dataMapping = tpMappingMean,
                            plotConfiguration = tpConfig)
# Show plot
meanPlot
```

### 5.5.2. Plot aggregated mean value by population

```{r, fig.height=5, fig.width=7.5}
# Map x, y and groupings
tpMappingMean <- TimeProfileDataMapping$new(x = "Time", 
                                            y = "SimulatedMean",
                                            groupings = Groupings$new(color = "Population"))

# Overwrite the plot configuration
tpConfig <-  TimeProfilePlotConfiguration$new(ylabel = "Simulated Results",
                                              xlabel = "Time",
                                              data=hlp$dfHelper,
                                              dataMapping = tpMappingMean)

# Define the ggplot object
meanPlot <- plotTimeProfile(data=hlp$dfHelper,
                            dataMapping = tpMappingMean,
                            plotConfiguration = tpConfig)
# Show plot
meanPlot
```

### 5.5.3. Plot aggregated min and max values

```{r, fig.height=5, fig.width=7.5}
# Map x, yMin and yMax
tpMappingRange <- TimeProfileDataMapping$new(x = "Time", 
                                             yMin = "SimulatedMin", 
                                             yMax = "SimulatedMax")

# Overwrite the plot configuration
tpConfig <-  TimeProfilePlotConfiguration$new(ylabel = "Simulated Results",
                                              xlabel = "Time",
                                              data=hlp$dfHelper,
                                              dataMapping = tpMappingRange)

# Define the ggplot object
rangePlot <- plotTimeProfile(data=hlp$dfHelper,
                            dataMapping = tpMappingRange)

# Show plot
rangePlot
```

### 5.5.4. Plot aggregated min and max values by population

```{r, fig.height=5, fig.width=7.5}
# Map x, yMin and yMax
tpMappingRange <- TimeProfileDataMapping$new(x = "Time", 
                                             yMin = "SimulatedMin", 
                                             yMax = "SimulatedMax",
                                             groupings = Groupings$new(fill = "Population"))

# Overwrite the plot configuration
tpConfig <-  TimeProfilePlotConfiguration$new(ylabel = "Simulated Results",
                                              xlabel = "Time",
                                              data=hlp$dfHelper,
                                              dataMapping = tpMappingRange)

# Define the ggplot object
rangePlot <- plotTimeProfile(data=hlp$dfHelper,
                            dataMapping = tpMappingRange,
                            plotConfiguration = tpConfig)

# Show plot
rangePlot
```

### 5.5.5. Plot aggregated mean, min, max values by population
```{r, fig.height=5, fig.width=7.5}
# Map x, y, yMin and yMax
tpMappingErrorBar <- TimeProfileDataMapping$new(x = "Time", 
                                                y = "SimulatedMean",
                                                yMin = "SimulatedMin", 
                                                yMax = "SimulatedMax",
                                                groupings = Groupings$new(color = "Population"))

# Overwrite the plot configuration
tpConfig <-  TimeProfilePlotConfiguration$new(ylabel = "Simulated Results",
                                              xlabel = "Time",
                                              data=hlp$dfHelper,
                                              dataMapping = tpMappingErrorBar)

# Define the ggplot object
errorBarPlot <- plotTimeProfile(data=hlp$dfHelper,
                                dataMapping = tpMappingErrorBar,
                                plotConfiguration = tpConfig)

# Show plot
errorBarPlot

```